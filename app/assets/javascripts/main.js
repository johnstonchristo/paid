var basiqUrl = "https://au-api.basiq.io/";

// // // // // // // // // // // // // // // // // //
// Below array contains entire transaction library
// // // // // // // // // // // // // // // // // //
var transactionArray = [
  { id: "d5a0841e-e889-4907-99dd-fbba01bcf2a5", amount: "10", date: "20" },
  { id: "417ba1c1-206c-4130-a0aa-beff398c76c1", amount: "15", date: "20" }
];
// // // // // // // // // // // // // // // // // //
// Below array contains outstanding tokens generated by user
// // // // // // // // // // // // // // // // // //
var transactionToken = [
  "d5a0841e-e889-4907-99dd-fbba01bcf2a5",
  "417ba1c1-206c-4130-a0aa-beff398c76c1"
];

var resultObject;
// // // // // // // // // // // // // // // // // //
// Below array contains matching objects from the entire trade library
// // // // // // // // // // // // // // // // // //
var matchingTransactionArray = [];
var userTransactionArray = ["318ca78f2855", "53c8f5489e45", "53c8f5489e46"];
var match;

// // // // // // // // // // // // // // // // // //
// Below obtains latest bank list
// // // // // // // // // // // // // // // // // //

var bankListBasiq = function(query) {
  $.ajax({
    url: "https://au-api.basiq.io/oauth2/token",
    method: "POST",
    dataType: "JSON",
    beforeSend: function(xhr) {
      xhr.setRequestHeader(
        "Authorization",
        "Basic MDg3OWQwMDktYTFhZi00MWI3LWI0NDctYjRmOWJhNTI2NDcxOmE4NjljZGM4LTVjZjUtNDYxZC04YjMzLTBhYWRhNzI1ZDk2NQ=="
      );
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      xhr.setRequestHeader("Accept", "application/json");
    },
    data: {
      grant_type: "client_credentials"
    }
  }).done(function(response) {
    var token = response.access_token;
    // console.log(token);

    $.ajax({
      url: "https://au-api.basiq.io/institutions",
      method: "GET",
      dataType: "JSON",
      beforeSend: function(xhr) {
        xhr.setRequestHeader("Authorization", "Bearer " + token);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.setRequestHeader("Accept", "application/json");
      }
    }).done(function(response) {
      var banksList = response.data;
      for (var i = 0; i < banksList.length; i++) {
        var bankName = banksList[i].name;

        var List = document.getElementById("bankList");
        var newListItem = document.createElement("option");
        newListItem.appendChild(document.createTextNode(banksList[i].name));

        List.appendChild(newListItem);
      }
    });
  });
};

// // // // // // // // // // // // // // // // //
// Below submits user details and creates a connection.
// // // // // // // // // // // // // // // // // //
// window.onload = function() {

var loginId = document.getElementById("clientId").value;
var password = document.getElementById("password").value;
// };

var submitUserDetails = function(query) {
  $.ajax({
    url: "https://au-api.basiq.io/oauth2/token",
    method: "POST",
    dataType: "JSON",
    beforeSend: function(xhr) {
      xhr.setRequestHeader(
        "Authorization",
        "Basic MDg3OWQwMDktYTFhZi00MWI3LWI0NDctYjRmOWJhNTI2NDcxOmE4NjljZGM4LTVjZjUtNDYxZC04YjMzLTBhYWRhNzI1ZDk2NQ=="
      );
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      xhr.setRequestHeader("Accept", "application/json");
    },
    data: {
      grant_type: "client_credentials"
    }
  }).done(function(response) {
    var token = response.access_token;

    $.ajax({
      url:
        basiqUrl + "connections/a4e21521-0401-4cd4-abf8-b501b2e4707e/refresh",
      method: "POST",
      dataType: "JSON",
      beforeSend: function(xhr) {
        xhr.setRequestHeader("Authorization", "Bearer " + token);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.setRequestHeader("Accept", "application/json");
      },
      data: JSON.stringify({
        loginId: "loginId",
        password: "password",
        externalUserId: "01",
        institution: {
          id: "AU00000"
        }
      })
    }).done(function(response) {
      var connectionInfo = response;
      transactionHistory(connectionInfo, token);
    });
  });
};

// // // // // // // // // // // // // // // // // //
// Below pulls all transaction history, and saves it into another function
// // // // // // // // // // // // // // // // // //

var transactionHistory = function(connectionInfo, token) {
  $.ajax({
    url: basiqUrl + "connections/" + connectionInfo.id + "/transactions",
    method: "GET",
    dataType: "JSON",
    beforeSend: function(xhr) {
      xhr.setRequestHeader("Authorization", "Bearer " + token);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.setRequestHeader("Accept", "application/json");
    }
  }).done(function(response) {
    transactionList = response;

    for (var i = 0; i < transactionList.data.length; i++) {
      var transaction = transactionList.data[i].id;
      individualTransaction(transaction, connectionInfo, token);
    }
  });
};

// // // // // // // // // // // // // // // // // //
// Below loops through each transaction object for more granular data.
// // // // // // // // // // // // // // // // // //

var individualTransaction = function(transaction, connectionInfo, token) {
  $.ajax({
    url:
      basiqUrl +
        "connections/" +
        connectionInfo.id +
        "/transactions/" +
        transaction,
    method: "GET",
    dataType: "JSON",
    beforeSend: function(xhr) {
      xhr.setRequestHeader("Authorization", "Bearer " + token);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.setRequestHeader("Accept", "application/json");
    }
  }).done(function(response) {
    singleTransaction = response;
    date = singleTransaction.postDate;
    amount = singleTransaction.amount;
    description = singleTransaction.description;
    transactionArray.push(singleTransaction);
  });
};

// // // // // // // // // // // // // // // // // //
//Below ajax request pull in transaction data from Ruby
// // // // // // // // // // // // // // // // // //

$.ajax({
  url: "http://localhost:3000/transactions",
  dataType: "JSON"
}).done(function(data) {
  for (var i = 0; i < data.length; i++) {
    userTransactionArray.push(data[i].token);
  }
});

// // // // // // // // // // // // // // // // // //
// Below waits until ajax requests have all loaded and then searches for the User Tokens in the entire array of trades.
// // // // // // // // // // // // // // // // // //

$(document).ajaxStop(function() {
  function search(transactionToken, transactionArray) {
    for (var i = 0; i < transactionToken.length; i++) {
      var seperateToken = transactionToken[i];
      for (var j = 0; j < transactionArray.length; j++) {
        if (transactionArray[j].id === seperateToken) {
          matchingTransactionArray.push(transactionArray[j]);

          var transactionList = document.getElementById("transactions");
          var idListItem = document.createElement("td");
          var dateListItem = document.createElement("td");
          var amountListItem = document.createElement("td");
          var rowItem = document.createElement("tr");

          var id = idListItem.appendChild(
            document.createTextNode(matchingTransactionArray[j].id)
          );

          var date = dateListItem.appendChild(
            document.createTextNode(matchingTransactionArray[j].date)
          );
          var amount = amountListItem.appendChild(
            document.createTextNode(matchingTransactionArray[j].amount)
          );

          rowItem.appendChild(document.createTextNode(id, date, amount));
          transactionList.appendChild(idListItem);
          transactionList.appendChild(dateListItem);
          transactionList.appendChild(amountListItem);
          // transactionList.appendChild(rowItem);
        }
      }
    }
    return matchingTransactionArray;
  }
  var resultObject = search(transactionToken, transactionArray);
});

// // // // // // // // // // // // // // // // // //
// Below appends transaction id's to page
// // // // // // // // // // // // // // // // // //

var results = [];

bankListBasiq();
window.onload = function() {
  document.getElementById("getUserDetails").onclick = submitUserDetails();
};
